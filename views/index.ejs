<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PokÃ©mon no Mundo Real</title>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet/dist/leaflet.css"
  />

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }

    #map {
      height: 100vh;
      width: 100%;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
    const map = L.map("map").setView([-30.0346, -51.2177], 4);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "Â© OpenStreetMap contributors",
    }).addTo(map);

    map.on("click", async function (e) {
        const { lat, lng } = e.latlng;
        const url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`;

        try {
            const response = await fetch(url);
            const data = await response.json();

            const place =
                data.address.city ||
                data.address.town ||
                data.address.village ||
                data.display_name;


            const climaRes = await fetch(`/clima/${lat}/${lng}`)
            const climaData = await climaRes.json()
            console.log(climaData)

            const descricao = climaData.weather[0].main;
            const temperatura = climaData.main.temp.toFixed(1);
            const umidade = climaData.main.humidity;
            const icone = climaData.weather[0].icon; 
            const iconeUrl = `http://openweathermap.org/img/wn/${icone}@2x.png`;

            const pokeRes = await fetch(`/pokemon/${descricao}`)
            const pokeData = await pokeRes.json()

            const indice = Math.floor(Math.random() * pokeData.length)
            const pokemonSprite = pokeData[indice].image
            const pokemonName = pokeData[indice].name

            L.popup()
                .setLatLng([lat, lng])
                .setContent(`
                    <div style="text-align:center; font-family:Arial, sans-serif;">
                        <h3 style="margin:0 0 5px 0;">${place}</h3>
                        <div style="display:flex; align-items:center; justify-content:center; gap:8px; margin-bottom:5px;">
                          <div>
                          <p>${pokemonName}</p>
                          <img src="${pokemonSprite}" alt="${descricao}" style="width:50px; height:50px;" />
                          </div>
                          <div>
                            <img src="${iconeUrl}" alt="${descricao}" style="width:40px; height:40px;" />
                            <span style="text-transform:capitalize;">${descricao}</span>
                          </div>
                        </div>
                        <div style="font-size:14px; line-height:1.4;">
                            <div>ðŸŒ¡ Temperatura: ${temperatura}Â°C</div>
                            <div>ðŸ’§ Umidade: ${umidade}%</div>
                        </div>
                    </div>
                `).openOn(map);
        } catch (error) {
            console.error("Erro ao buscar cidade:", error);
        }
    });
</script>
</body>
</html>
